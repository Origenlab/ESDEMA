---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const estados = await getCollection('estados');
const alcaldias = await getCollection('alcaldias');
const escuelas = await getCollection('escuelas');
const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

const escuelasDestacadas = [...escuelas]
  .sort((a, b) => b.data.rating - a.data.rating || b.data.totalResenas - a.data.totalResenas)
  .slice(0, 4);

// Extraer testimonios de las escuelas
const testimonios = escuelas.flatMap(e =>
  e.data.resenas.slice(0, 1).map(r => ({
    ...r,
    escuela: e.data.nombreComercial,
    zona: e.data.colonia
  }))
).slice(0, 3);

const totalResenas = escuelas.reduce((acc, e) => acc + e.data.totalResenas, 0);
---

<BaseLayout
  title="ESDEMA | Directorio de Escuelas de Manejo en Mexico"
  description="Encuentra las mejores escuelas de manejo cerca de ti. Compara precios, lee resenas verificadas y contacta por WhatsApp. Directorio profesional con escuelas en CDMX y todo Mexico."
  canonicalPath="/"
>
  <!-- Hero Section -->
  <section class="hero hero-home">
    <div class="container">
      <div class="hero-content">
        <div class="hero-badge">
          <span class="hero-badge-dot"></span>
          <span>+{escuelas.length} escuelas verificadas</span>
        </div>

        <h1>
          Encuentra la mejor <span class="highlight">escuela de manejo</span> cerca de ti
        </h1>

        <p class="hero-description">
          Directorio profesional de escuelas de manejo en Mexico. Compara precios,
          lee resenas reales y contacta directamente por WhatsApp.
        </p>

        <div class="hero-actions">
          <a href="/cdmx/" class="btn btn-primary btn-lg">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
            Explorar CDMX
          </a>
          <a href="/estados/" class="btn btn-secondary btn-lg">
            Ver todos los estados
          </a>
        </div>

        <div class="hero-stats">
          <div class="hero-stat">
            <div class="hero-stat-value">{escuelas.length}+</div>
            <div class="hero-stat-label">Escuelas verificadas</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value">{alcaldias.length}</div>
            <div class="hero-stat-label">Zonas cubiertas</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value">{totalResenas}+</div>
            <div class="hero-stat-label">Resenas reales</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Trust Badges -->
  <section class="section-sm section-alt">
    <div class="container">
      <div class="trust-badges">
        <div class="trust-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <span>Escuelas verificadas</span>
        </div>
        <div class="trust-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          <span>Informacion confiable</span>
        </div>
        <div class="trust-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
          <span>Datos protegidos</span>
        </div>
        <div class="trust-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
          </svg>
          <span>Contacto directo</span>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2>Como funciona</h2>
        <p>Encontrar tu escuela de manejo ideal es facil con ESDEMA</p>
      </div>

      <div class="steps-grid">
        <article class="step">
          <div class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
          </div>
          <h3>Busca por zona</h3>
          <p>Explora escuelas de manejo por estado, alcaldia o colonia. Encuentra opciones cerca de tu ubicacion.</p>
        </article>

        <article class="step">
          <div class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
          </div>
          <h3>Compara opciones</h3>
          <p>Revisa precios, servicios, horarios y resenas de alumnos reales para tomar la mejor decision.</p>
        </article>

        <article class="step">
          <div class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/>
            </svg>
          </div>
          <h3>Contacta directo</h3>
          <p>Comunicate directamente con la escuela via WhatsApp o telefono. Sin intermediarios.</p>
        </article>
      </div>
    </div>
  </section>

  <!-- Featured Schools -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-header">
        <h2>Escuelas destacadas</h2>
        <p>Las escuelas mejor valoradas por nuestros usuarios</p>
      </div>

      <div class="grid grid-2">
        {escuelasDestacadas.map((escuela) => (
          <article class="card school-card">
            {escuela.data.badges.includes('Verificada') && (
              <span class="school-card-badge">Verificada</span>
            )}
            <div class="school-card-image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                <circle cx="7" cy="17" r="2"/>
                <path d="M9 17h6"/>
                <circle cx="17" cy="17" r="2"/>
              </svg>
            </div>
            <div class="school-card-content">
              <div class="school-card-location">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
                <span>{escuela.data.colonia}, {escuela.data.alcaldiaSlug.replaceAll('-', ' ')}</span>
              </div>
              <h3>
                <a href={`/${escuela.data.estadoSlug}/${escuela.data.alcaldiaSlug}/${escuela.slug}/`}>
                  {escuela.data.nombreComercial}
                </a>
              </h3>
              <div class="school-card-meta">
                <div class="school-card-rating">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                  </svg>
                  <span>{escuela.data.rating.toFixed(1)}</span>
                  <small>({escuela.data.totalResenas} resenas)</small>
                </div>
                <div class="school-card-price">
                  Desde {escuela.data.precioDesde}
                </div>
              </div>
            </div>
          </article>
        ))}
      </div>

      <div class="text-center mt-xl">
        <a href="/cdmx/" class="btn btn-primary">
          Ver todas las escuelas
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"/>
            <polyline points="12 5 19 12 12 19"/>
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- Zones / States -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2>Explora por zona</h2>
        <p>Encuentra escuelas de manejo en tu ciudad o estado</p>
      </div>

      <div class="grid grid-3">
        {estados.map((estado) => (
          <article class="location-card">
            <div class="location-card-header">
              <div class="location-card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
              </div>
              <h3>
                <a href={`/${estado.slug}/`}>{estado.data.nombre}</a>
              </h3>
            </div>
            <p>{estado.data.descripcionCorta}</p>
            <div class="location-card-stats">
              <span><strong>{estado.data.alcaldiasAprox}</strong> zonas</span>
              <span><strong>{estado.data.escuelasAprox}+</strong> escuelas</span>
            </div>
          </article>
        ))}

        {alcaldias.slice(0, 2).map((alcaldia) => (
          <article class="location-card">
            <div class="location-card-header">
              <div class="location-card-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                  <path d="M9 22v-4h6v4"/>
                  <path d="M8 6h.01"/>
                  <path d="M16 6h.01"/>
                  <path d="M12 6h.01"/>
                  <path d="M12 10h.01"/>
                  <path d="M12 14h.01"/>
                  <path d="M16 10h.01"/>
                  <path d="M16 14h.01"/>
                  <path d="M8 10h.01"/>
                  <path d="M8 14h.01"/>
                </svg>
              </div>
              <h3>
                <a href={`/cdmx/${alcaldia.slug.replace('cdmx-', '')}/`}>
                  {alcaldia.data.nombre}
                </a>
              </h3>
            </div>
            <p>{alcaldia.data.descripcionCorta}</p>
            <div class="location-card-stats">
              <span><strong>{alcaldia.data.coloniasAprox}</strong> colonias</span>
              <span><strong>{alcaldia.data.escuelasAprox}+</strong> escuelas</span>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <!-- Testimonials -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-header">
        <h2>Lo que dicen nuestros usuarios</h2>
        <p>Resenas reales de alumnos que encontraron su escuela en ESDEMA</p>
      </div>

      <div class="testimonials-grid">
        {testimonios.map((testimonio) => (
          <article class="testimonial">
            <div class="testimonial-stars">
              {[...Array(testimonio.rating)].map(() => (
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
              ))}
            </div>
            <p class="testimonial-text">"{testimonio.texto}"</p>
            <div class="testimonial-author">
              <div class="testimonial-avatar">
                {testimonio.autor.charAt(0)}
              </div>
              <div class="testimonial-info">
                <strong>{testimonio.autor}</strong>
                <span>{testimonio.escuela}</span>
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>

  <!-- Blog / Resources -->
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h2>Recursos y guias</h2>
        <p>Consejos utiles para aprender a manejar con confianza</p>
      </div>

      <div class="grid grid-3">
        {posts.map((post) => (
          <article class="blog-card">
            <div class="blog-card-image"></div>
            <div class="blog-card-content">
              <span class="badge badge-primary blog-card-category">{post.data.category}</span>
              <h3>
                <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
              </h3>
              <p>{post.data.description}</p>
            </div>
          </article>
        ))}
      </div>

      <div class="text-center mt-xl">
        <a href="/blog/" class="btn btn-secondary">
          Ver todos los articulos
        </a>
      </div>
    </div>
  </section>

  <!-- FAQ Preview -->
  <section class="section section-alt">
    <div class="container">
      <div class="section-header">
        <h2>Preguntas frecuentes</h2>
        <p>Resolvemos tus dudas sobre escuelas de manejo</p>
      </div>

      <div class="faq-grid">
        <details class="faq-item">
          <summary>¿Como elijo la mejor escuela de manejo?</summary>
          <div class="faq-item-content">
            <p>Considera factores como ubicacion, precios, horarios flexibles, tipo de vehiculos (automatico o estandar), resenas de otros alumnos y si cuentan con instructores certificados. En ESDEMA puedes comparar todas estas caracteristicas facilmente.</p>
          </div>
        </details>

        <details class="faq-item">
          <summary>¿Cuanto cuesta aprender a manejar?</summary>
          <div class="faq-item-content">
            <p>Los precios varian segun la ciudad y el paquete que elijas. En CDMX, los cursos basicos van desde $1,200 MXN hasta $5,000 MXN aproximadamente. Recomendamos comparar varias opciones antes de decidir.</p>
          </div>
        </details>

        <details class="faq-item">
          <summary>¿Es mejor aprender en automatico o estandar?</summary>
          <div class="faq-item-content">
            <p>Depende de tus necesidades. Si planeas manejar solo vehiculos automaticos, es mas facil empezar con ellos. Sin embargo, aprender en estandar te da mas versatilidad. Lee nuestro articulo completo sobre este tema en el blog.</p>
          </div>
        </details>

        <details class="faq-item">
          <summary>¿Las escuelas listadas estan verificadas?</summary>
          <div class="faq-item-content">
            <p>Si, en ESDEMA verificamos la informacion de contacto, ubicacion y servicios de cada escuela. Las escuelas con la insignia "Verificada" han pasado por un proceso adicional de validacion.</p>
          </div>
        </details>
      </div>

      <div class="text-center mt-xl">
        <a href="/faq/" class="btn btn-secondary">
          Ver todas las preguntas
        </a>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="cta-section">
    <div class="container">
      <div class="cta-content">
        <h2>¿Listo para aprender a manejar?</h2>
        <p>
          Encuentra la escuela perfecta para ti. Compara precios,
          lee resenas y contacta directamente.
        </p>
        <div class="cta-actions">
          <a href="/cdmx/" class="btn btn-accent btn-lg">
            Explorar escuelas
          </a>
          <a href="/contacto/" class="btn btn-secondary btn-lg">
            Contactanos
          </a>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  /* Page-specific styles */
  .hero-content {
    animation: fadeInUp 0.6s ease-out;
  }

  .steps-grid .step {
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
  }

  .steps-grid .step:nth-child(1) { animation-delay: 0.1s; }
  .steps-grid .step:nth-child(2) { animation-delay: 0.2s; }
  .steps-grid .step:nth-child(3) { animation-delay: 0.3s; }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
